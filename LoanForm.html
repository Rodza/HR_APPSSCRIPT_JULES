<!-- Loan Form -->
<form id="loan-form">
  <div class="form-group">
    <label for="employee-name-loan">Employee Name</label>
    <select id="employee-name-loan" name="employee-name-loan" required>
      <!-- Employee names will be populated dynamically -->
    </select>
  </div>
  
  <div class="form-group">
    <label for="loan-amount">Loan Amount</label>
    <input type="number" id="loan-amount" name="loan-amount" step="0.01" required>
  </div>
  
  <div class="form-group">
    <label for="loan-type">Loan Type</label>
    <select id="loan-type" name="loan-type" required>
      <option value="Disbursement">Disbursement</option>
      <option value="Repayment">Repayment</option>
    </select>
  </div>
  
  <!-- BUG-004 FIX: Added TransactionDate field -->
  <div class="form-group">
    <label for="transaction-date">Transaction Date</label>
    <input type="date" id="transaction-date" name="transaction-date" required>
  </div>
  
  <div class="form-group">
    <label for="disbursement-mode">Disbursement Mode</label>
    <select id="disbursement-mode" name="disbursement-mode" required>
      <option value="With Salary">With Salary</option>
      <option value="Separate">Separate</option>
      <option value="Manual Entry">Manual Entry</option>
    </select>
  </div>
  
  <div class="form-group">
    <label for="loan-notes">Notes</label>
    <textarea id="loan-notes" name="loan-notes"></textarea>
  </div>
  
  <button type="submit" class="btn btn-primary">Record Loan Transaction</button>
  <button type="button" class="btn btn-secondary" onclick="closeLoanForm()">Cancel</button>
</form>

<script>
// BUG-013 FIX: JavaScript to capture form data including TransactionDate

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
  var today = new Date().toISOString().split('T')[0];
  document.getElementById('transaction-date').value = today;
  
  // Load employees into dropdown
  google.script.run
    .withSuccessHandler(populateEmployees)
    .withFailureHandler(function(error) {
      console.error('Failed to load employees:', error);
      var select = document.getElementById('employee-name-loan');
      select.innerHTML = '<option value="">Error loading employees</option>';
      showMessage('Failed to load employees: ' + error.message, 'error');
    })
    .listEmployees();
});

function populateEmployees(employees) {
  var select = document.getElementById('employee-name-loan');
  select.innerHTML = '<option value="">-- Select Employee --</option>';
  
  // listEmployees() returns array directly, not wrapped in result object
  if (employees && employees.length > 0) {
    employees.forEach(function(emp) {
      var option = document.createElement('option');
      option.value = emp.REFNAME;
      option.textContent = emp.REFNAME;
      select.appendChild(option);
    });
  } else {
    select.innerHTML = '<option value="">No employees found</option>';
  }
}

// Form submission handler
document.getElementById('loan-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // BUG-013 FIX: Capture TransactionDate field
  var formData = {
    'Employee Name': document.getElementById('employee-name-loan').value,
    LoanAmount: parseFloat(document.getElementById('loan-amount').value),
    LoanType: document.getElementById('loan-type').value,
    TransactionDate: document.getElementById('transaction-date').value,  // âœ… BUG-013 FIXED
    DisbursementMode: document.getElementById('disbursement-mode').value,
    Notes: document.getElementById('loan-notes').value || ''
  };
  
  // Validate
  if (!formData['Employee Name']) {
    showMessage('Please select an employee', 'error');
    return;
  }
  
  if (!formData.LoanAmount || formData.LoanAmount <= 0) {
    showMessage('Please enter a valid loan amount', 'error');
    return;
  }
  
  if (!formData.TransactionDate) {
    showMessage('Please select a transaction date', 'error');
    return;
  }
  
  // Show loading
  showMessage('Recording loan transaction...', 'info');
  
  // Submit to server
  google.script.run
    .withSuccessHandler(onLoanSuccess)
    .withFailureHandler(onLoanError)
    .addLoanTransaction(formData);
});

function onLoanSuccess(result) {
  if (result.success) {
    showMessage(result.message, 'success');
    document.getElementById('loan-form').reset();
    // Set date back to today
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('transaction-date').value = today;
  } else {
    showMessage(result.message || 'Failed to record loan transaction', 'error');
    if (result.errors) {
      result.errors.forEach(function(error) {
        showMessage(error, 'error');
      });
    }
  }
}

function onLoanError(error) {
  showMessage('Error: ' + error.message, 'error');
  console.error('Loan form error:', error);
}

function showMessage(message, type) {
  // Create or update message div
  var msgDiv = document.getElementById('loan-form-message');
  if (!msgDiv) {
    msgDiv = document.createElement('div');
    msgDiv.id = 'loan-form-message';
    document.getElementById('loan-form').insertAdjacentElement('beforebegin', msgDiv);
  }
  
  msgDiv.className = 'alert alert-' + type;
  msgDiv.textContent = message;
  msgDiv.style.display = 'block';
  
  // Auto-hide after 5 seconds
  if (type !== 'error') {
    setTimeout(function() {
      msgDiv.style.display = 'none';
    }, 5000);
  }
}

function closeLoanForm() {
  // Close modal or navigate back
  google.script.host.close();
}
</script>

<style>
.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.form-group textarea {
  min-height: 80px;
  resize: vertical;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-right: 10px;
}

.btn-primary {
  background-color: #007bff;
  color: white;
}

.btn-primary:hover {
  background-color: #0056b3;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background-color: #545b62;
}

.alert {
  padding: 12px;
  margin-bottom: 15px;
  border-radius: 4px;
  display: none;
}

.alert-success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.alert-error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.alert-info {
  background-color: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}
</style>
