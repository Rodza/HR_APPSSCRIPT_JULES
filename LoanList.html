<!-- LoanList.html -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="mb-0">Loan Management</h3>
    <button class="btn btn-primary" onclick="loadView('loan-add')">
      <i class="bi bi-plus-circle"></i> Add Loan Transaction
    </button>
  </div>
  <div class="card-body">
    
    <!-- Employee Selector and Balance Widget -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label for="loanEmployeeSelect" class="form-label"><strong>Select Employee:</strong></label>
        <select class="form-select" id="loanEmployeeSelect" onchange="loadEmployeeLoanHistory()">
          <option value="">-- Select an employee --</option>
        </select>
      </div>
      <div class="col-md-6">
        <div id="loanBalanceWidget" class="alert alert-info mb-0" style="display:none;">
          <h5 class="mb-2">Current Loan Balance</h5>
          <h3 id="currentBalance" class="mb-0">R 0.00</h3>
        </div>
      </div>
    </div>
    
    <!-- Loan Transaction History Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Transaction Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Balance Before</th>
            <th>Balance After</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="loanTableBody">
          <tr>
            <td colspan="6" class="text-center text-muted">
              Select an employee to view their loan history
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Transaction Count -->
    <div class="mt-2 text-muted">
      <small id="loanCount">No employee selected</small>
    </div>
    
  </div>
</div>

<script>
  // Store loan data
  var currentEmployeeLoanHistory = [];
  var currentEmployeeId = null;
  
  /**
   * Load employee list into dropdown
   */
  function loadEmployeeList() {
    google.script.run
      .withSuccessHandler(function(employees) {
        var select = document.getElementById('loanEmployeeSelect');
        select.innerHTML = '<option value="">-- Select an employee --</option>';
        
        if (employees && employees.length > 0) {
          for (var i = 0; i < employees.length; i++) {
            var emp = employees[i];
            var option = document.createElement('option');
            option.value = emp.id;
            option.textContent = emp.REFNAME + ' (' + emp.EMPLOYER + ')';
            select.appendChild(option);
          }
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error loading employees:', error);
      })
      .listEmployees({});
  }
  
  /**
   * Load loan history for selected employee
   */
  function loadEmployeeLoanHistory() {
    var select = document.getElementById('loanEmployeeSelect');
    var employeeId = select.value;
    
    if (!employeeId) {
      document.getElementById('loanTableBody').innerHTML = 
        '<tr><td colspan="6" class="text-center text-muted">Select an employee to view their loan history</td></tr>';
      document.getElementById('loanBalanceWidget').style.display = 'none';
      document.getElementById('loanCount').textContent = 'No employee selected';
      return;
    }
    
    currentEmployeeId = employeeId;
    
    // Show loading
    document.getElementById('loanTableBody').innerHTML = 
      '<tr><td colspan="6" class="text-center">' +
      '<div class="spinner-border spinner-border-sm" role="status">' +
      '<span class="visually-hidden">Loading...</span>' +
      '</div> Loading loan history...</td></tr>';
    
    // Load loan history
    google.script.run
      .withSuccessHandler(displayLoanHistory)
      .withFailureHandler(function(error) {
        document.getElementById('loanTableBody').innerHTML = 
          '<tr><td colspan="6" class="text-center text-danger">Error loading loan history: ' + error.message + '</td></tr>';
      })
      .getLoanHistory(employeeId);
    
    // Load current balance
    google.script.run
      .withSuccessHandler(function(balance) {
        document.getElementById('currentBalance').textContent = 'R ' + balance.toFixed(2);
        document.getElementById('loanBalanceWidget').style.display = 'block';
      })
      .withFailureHandler(function(error) {
        console.error('Error loading balance:', error);
      })
      .getCurrentLoanBalance(employeeId);
  }
  
  /**
   * Display loan history in table
   */
  function displayLoanHistory(transactions) {
    currentEmployeeLoanHistory = transactions;
    var tbody = document.getElementById('loanTableBody');
    tbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No loan transactions found for this employee</td></tr>';
      document.getElementById('loanCount').textContent = 'No transactions';
      return;
    }
    
    for (var i = 0; i < transactions.length; i++) {
      var txn = transactions[i];
      var row = document.createElement('tr');
      
      // Transaction Date
      var dateCell = document.createElement('td');
      dateCell.textContent = formatDate(txn.TransactionDate);
      row.appendChild(dateCell);
      
      // Type
      var typeCell = document.createElement('td');
      var typeBadge = document.createElement('span');
      typeBadge.className = 'badge ' + (txn.LoanType === 'Disbursement' ? 'bg-danger' : 'bg-success');
      typeBadge.textContent = txn.LoanType || '';
      typeCell.appendChild(typeBadge);
      row.appendChild(typeCell);
      
      // Amount
      var amountCell = document.createElement('td');
      amountCell.textContent = 'R ' + (txn.LoanAmount || 0).toFixed(2);
      amountCell.className = txn.LoanType === 'Disbursement' ? 'text-danger' : 'text-success';
      row.appendChild(amountCell);
      
      // Balance Before
      var beforeCell = document.createElement('td');
      beforeCell.textContent = 'R ' + (txn.BalanceBefore || 0).toFixed(2);
      row.appendChild(beforeCell);
      
      // Balance After
      var afterCell = document.createElement('td');
      afterCell.textContent = 'R ' + (txn.BalanceAfter || 0).toFixed(2);
      row.appendChild(afterCell);
      
      // Notes
      var notesCell = document.createElement('td');
      notesCell.textContent = txn.Notes || '-';
      notesCell.style.maxWidth = '200px';
      notesCell.style.overflow = 'hidden';
      notesCell.style.textOverflow = 'ellipsis';
      notesCell.style.whiteSpace = 'nowrap';
      row.appendChild(notesCell);
      
      tbody.appendChild(row);
    }
    
    // Update count
    document.getElementById('loanCount').textContent = 
      'Showing ' + transactions.length + ' transaction' + (transactions.length !== 1 ? 's' : '');
  }
  
  /**
   * Format date for display
   */
  function formatDate(date) {
    if (!date) return '-';
    var d = new Date(date);
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleDateString('en-ZA');
  }
  
  // Auto-load employee list on page load
  loadEmployeeList();
</script>
