<!-- PayrollList.html -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="mb-0">Payroll Management</h3>
    <button class="btn btn-primary" onclick="loadView('payroll-add')">
      <i class="bi bi-plus-circle"></i> Create Payslip
    </button>
  </div>
  <div class="card-body">
    
    <!-- Search and Filter -->
    <div class="row mb-3">
      <div class="col-md-4">
        <input type="text" class="form-control" id="payrollEmployeeSearch" placeholder="Search by employee name..." onkeyup="applyPayrollFilters()">
      </div>
      <div class="col-md-3">
        <input type="week" class="form-control" id="payrollWeekEndingFilter" onchange="applyPayrollFilters()" placeholder="Filter by week">
      </div>
      <div class="col-md-3">
        <select class="form-select" id="payrollEmployerFilter" onchange="applyPayrollFilters()">
          <option value="">All Employers</option>
          <option value="SA Grinding Wheels">SA Grinding Wheels</option>
          <option value="Scorpio Abrasives">Scorpio Abrasives</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-secondary w-100" onclick="clearPayrollFilters()">Clear Filters</button>
      </div>
    </div>
    
    <!-- Payroll Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Record #</th>
            <th>Employee Name</th>
            <th>Week Ending</th>
            <th>Gross Salary</th>
            <th>Total Deductions</th>
            <th>Nett Salary</th>
            <th>Paid to Account</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="payrollTableBody">
          <tr>
            <td colspan="8" class="text-center">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              Loading payslips...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Payslip Count -->
    <div class="mt-2 text-muted">
      <small id="payrollCount">Loading...</small>
    </div>
    
  </div>
</div>

<script>
  // Store all payslips for client-side filtering
  var allPayslips = [];
  
  /**
   * Load payslips from server
   */
  function loadPayslips() {
    var filters = {
      employeeName: document.getElementById('payrollEmployeeSearch').value,
      weekEnding: document.getElementById('payrollWeekEndingFilter').value,
      employer: document.getElementById('payrollEmployerFilter').value
    };
    
    google.script.run
      .withSuccessHandler(displayPayslips)
      .withFailureHandler(function(error) {
        document.getElementById('payrollTableBody').innerHTML = 
          '<tr><td colspan="8" class="text-center text-danger">Error loading payslips: ' + error.message + '</td></tr>';
      })
      .listPayslips(filters);
  }
  
  /**
   * Display payslips in table
   */
  function displayPayslips(payslips) {
    allPayslips = payslips;
    var tbody = document.getElementById('payrollTableBody');
    tbody.innerHTML = '';
    
    if (!payslips || payslips.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No payslips found</td></tr>';
      document.getElementById('payrollCount').textContent = 'No payslips';
      return;
    }
    
    for (var i = 0; i < payslips.length; i++) {
      var payslip = payslips[i];
      var row = document.createElement('tr');
      
      // Record Number
      var recordCell = document.createElement('td');
      recordCell.innerHTML = '<strong>' + (payslip.RecordNumber || '-') + '</strong>';
      row.appendChild(recordCell);
      
      // Employee Name
      var nameCell = document.createElement('td');
      nameCell.textContent = payslip['Employee Name'] || '';
      row.appendChild(nameCell);
      
      // Week Ending
      var weekCell = document.createElement('td');
      weekCell.textContent = formatDate(payslip['Week Ending']);
      row.appendChild(weekCell);
      
      // Gross Salary
      var grossCell = document.createElement('td');
      grossCell.textContent = 'R ' + (payslip['Gross Salary'] || 0).toFixed(2);
      row.appendChild(grossCell);
      
      // Total Deductions
      var deductCell = document.createElement('td');
      deductCell.textContent = 'R ' + (payslip['Total Deductions'] || 0).toFixed(2);
      deductCell.className = 'text-danger';
      row.appendChild(deductCell);
      
      // Nett Salary
      var nettCell = document.createElement('td');
      nettCell.innerHTML = '<strong>R ' + (payslip['Nett Salary'] || 0).toFixed(2) + '</strong>';
      nettCell.className = 'text-success';
      row.appendChild(nettCell);
      
      // Paid to Account
      var paidCell = document.createElement('td');
      paidCell.innerHTML = '<strong>R ' + (payslip['Paid to Account'] || 0).toFixed(2) + '</strong>';
      paidCell.className = 'text-primary';
      row.appendChild(paidCell);
      
      // Actions
      var actionsCell = document.createElement('td');
      var actionsHtml = '<button class="btn btn-sm btn-info me-1" onclick="viewPayslipPDF(\'' + payslip.RecordNumber + '\')">PDF</button>';
      actionsCell.innerHTML = actionsHtml;
      row.appendChild(actionsCell);
      
      tbody.appendChild(row);
    }
    
    // Update count
    document.getElementById('payrollCount').textContent = 
      'Showing ' + payslips.length + ' payslip' + (payslips.length !== 1 ? 's' : '');
  }
  
  /**
   * Apply filters
   */
  function applyPayrollFilters() {
    loadPayslips();
  }
  
  /**
   * Clear all filters
   */
  function clearPayrollFilters() {
    document.getElementById('payrollEmployeeSearch').value = '';
    document.getElementById('payrollWeekEndingFilter').value = '';
    document.getElementById('payrollEmployerFilter').value = '';
    loadPayslips();
  }
  
  /**
   * View payslip PDF
   */
  function viewPayslipPDF(recordNumber) {
    if (!recordNumber) {
      alert('Record number is required to generate PDF');
      return;
    }
    
    // Show loading
    var btn = event.target;
    var originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Generating...';
    
    google.script.run
      .withSuccessHandler(function(pdfUrl) {
        btn.disabled = false;
        btn.textContent = originalText;
        if (pdfUrl) {
          window.open(pdfUrl, '_blank');
        } else {
          alert('Error: Could not generate PDF');
        }
      })
      .withFailureHandler(function(error) {
        btn.disabled = false;
        btn.textContent = originalText;
        alert('Error generating PDF: ' + error.message);
      })
      .generatePayslipPDF(recordNumber);
  }
  
  /**
   * Format date for display
   */
  function formatDate(date) {
    if (!date) return '-';
    var d = new Date(date);
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleDateString('en-ZA');
  }
  
  // Auto-load payslips on page load
  loadPayslips();
</script>
