<!-- TimesheetList.html -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="mb-0">Timesheet Management</h3>
    <button class="btn btn-primary" onclick="loadView('timesheet-import')">
      <i class="bi bi-upload"></i> Import Timesheets
    </button>
  </div>
  <div class="card-body">
    
    <!-- Status Filter -->
    <div class="row mb-3">
      <div class="col-md-4">
        <input type="text" class="form-control" id="timesheetEmployeeSearch" placeholder="Search by employee name..." onkeyup="applyTimesheetFilters()">
      </div>
      <div class="col-md-3">
        <select class="form-select" id="timesheetStatusFilter" onchange="applyTimesheetFilters()">
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="">All Statuses</option>
        </select>
      </div>
      <div class="col-md-3">
        <input type="week" class="form-control" id="timesheetWeekFilter" onchange="applyTimesheetFilters()" placeholder="Filter by week">
      </div>
      <div class="col-md-2">
        <button class="btn btn-secondary w-100" onclick="clearTimesheetFilters()">Clear Filters</button>
      </div>
    </div>
    
    <!-- Timesheet Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Employee Name</th>
            <th>Week Ending</th>
            <th>Standard Hours</th>
            <th>Overtime Hours</th>
            <th>Total Hours</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="timesheetTableBody">
          <tr>
            <td colspan="7" class="text-center">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              Loading timesheets...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Timesheet Count -->
    <div class="mt-2 text-muted">
      <small id="timesheetCount">Loading...</small>
    </div>
    
  </div>
</div>

<script>
  // Store all timesheets
  var allTimesheets = [];
  
  /**
   * Load timesheets from server
   */
  function loadTimesheets() {
    var filters = {
      employeeName: document.getElementById('timesheetEmployeeSearch').value,
      status: document.getElementById('timesheetStatusFilter').value,
      weekEnding: document.getElementById('timesheetWeekFilter').value
    };
    
    google.script.run
      .withSuccessHandler(displayTimesheets)
      .withFailureHandler(function(error) {
        document.getElementById('timesheetTableBody').innerHTML = 
          '<tr><td colspan="7" class="text-center text-danger">Error loading timesheets: ' + error.message + '</td></tr>';
      })
      .listPendingTimesheets(filters);
  }
  
  /**
   * Display timesheets in table
   */
  function displayTimesheets(timesheets) {
    allTimesheets = timesheets;
    var tbody = document.getElementById('timesheetTableBody');
    tbody.innerHTML = '';
    
    if (!timesheets || timesheets.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No timesheets found</td></tr>';
      document.getElementById('timesheetCount').textContent = 'No timesheets';
      return;
    }
    
    for (var i = 0; i < timesheets.length; i++) {
      var timesheet = timesheets[i];
      var row = document.createElement('tr');
      
      // Employee Name
      var nameCell = document.createElement('td');
      nameCell.innerHTML = '<strong>' + escapeHtml(timesheet['Employee Name'] || '') + '</strong>';
      row.appendChild(nameCell);
      
      // Week Ending
      var weekCell = document.createElement('td');
      weekCell.textContent = formatDate(timesheet['Week Ending']);
      row.appendChild(weekCell);
      
      // Standard Hours
      var stdCell = document.createElement('td');
      stdCell.textContent = (timesheet['Standard Hours'] || 0).toFixed(2);
      row.appendChild(stdCell);
      
      // Overtime Hours
      var otCell = document.createElement('td');
      otCell.textContent = (timesheet['Overtime Hours'] || 0).toFixed(2);
      otCell.className = 'text-warning';
      row.appendChild(otCell);
      
      // Total Hours
      var totalCell = document.createElement('td');
      var totalHours = (timesheet['Standard Hours'] || 0) + (timesheet['Overtime Hours'] || 0);
      totalCell.innerHTML = '<strong>' + totalHours.toFixed(2) + '</strong>';
      row.appendChild(totalCell);
      
      // Status
      var statusCell = document.createElement('td');
      var statusBadge = document.createElement('span');
      statusBadge.className = 'badge ' + getStatusBadgeClass(timesheet.Status);
      statusBadge.textContent = timesheet.Status || 'Pending';
      statusCell.appendChild(statusBadge);
      row.appendChild(statusCell);
      
      // Actions
      var actionsCell = document.createElement('td');
      if (timesheet.Status === 'Pending') {
        actionsCell.innerHTML = 
          '<button class="btn btn-sm btn-success me-1" onclick="approveTimesheet(\'' + timesheet.id + '\')">Approve</button>' +
          '<button class="btn btn-sm btn-danger" onclick="rejectTimesheet(\'' + timesheet.id + '\')">Reject</button>';
      } else {
        actionsCell.innerHTML = '<span class="text-muted">-</span>';
      }
      row.appendChild(actionsCell);
      
      tbody.appendChild(row);
    }
    
    // Update count
    document.getElementById('timesheetCount').textContent = 
      'Showing ' + timesheets.length + ' timesheet' + (timesheets.length !== 1 ? 's' : '');
  }
  
  /**
   * Apply filters
   */
  function applyTimesheetFilters() {
    loadTimesheets();
  }
  
  /**
   * Clear all filters
   */
  function clearTimesheetFilters() {
    document.getElementById('timesheetEmployeeSearch').value = '';
    document.getElementById('timesheetStatusFilter').value = 'Pending';
    document.getElementById('timesheetWeekFilter').value = '';
    loadTimesheets();
  }
  
  /**
   * Approve timesheet
   */
  function approveTimesheet(timesheetId) {
    if (!confirm('Are you sure you want to approve this timesheet?')) {
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert('Timesheet approved successfully');
          loadTimesheets(); // Reload list
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error approving timesheet: ' + error.message);
      })
      .approveTimesheet(timesheetId);
  }
  
  /**
   * Reject timesheet
   */
  function rejectTimesheet(timesheetId) {
    var reason = prompt('Enter reason for rejection:');
    if (!reason) return;
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert('Timesheet rejected');
          loadTimesheets(); // Reload list
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error rejecting timesheet: ' + error.message);
      })
      .rejectTimesheet(timesheetId);
  }
  
  /**
   * Get badge class for status
   */
  function getStatusBadgeClass(status) {
    if (status === 'Approved') return 'bg-success';
    if (status === 'Rejected') return 'bg-danger';
    if (status === 'Pending') return 'bg-warning';
    return 'bg-secondary';
  }
  
  /**
   * Format date for display
   */
  function formatDate(date) {
    if (!date) return '-';
    var d = new Date(date);
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleDateString('en-ZA');
  }
  
  /**
   * Escape HTML to prevent XSS
   */
  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function loadTimesheets() {
    var status = document.getElementById('timesheetStatusFilter').value;
    google.script.run.withSuccessHandler(displayTimesheets).listPendingTimesheets({status: status});
  }

  function displayTimesheets(timesheets) {
    var tableBody = document.getElementById('timesheetTableBody');
    tableBody.innerHTML = '';
    timesheets.forEach(function(t) {
      var row = tableBody.insertRow();
      row.insertCell().textContent = t['Employee Name'];
      row.insertCell().textContent = new Date(t['Week Ending']).toLocaleDateString();
      row.insertCell().textContent = t['Standard Hours'];
      row.insertCell().textContent = t['Overtime Hours'];
      row.insertCell().textContent = t['Total Hours'];
      row.insertCell().textContent = t['Status'];
      var actionsCell = row.insertCell();
      actionsCell.innerHTML = '<button onclick="approveTimesheet(\'' + t.id + '\')">Approve</button> ' +
                              '<button onclick="rejectTimesheet(\'' + t.id + '\')">Reject</button>';
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    fetchTimesheets();
  });
</script>
